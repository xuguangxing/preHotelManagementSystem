<!-- 头部 -->
<!DOCTYPE html>
<html class="fly-html-layui fly-html-store">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!--<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">-->
    <meta name="keywords" content="酒店管理系统">
    <meta name="description" content="酒店管理系统">
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css">
    <link rel="stylesheet" href="/layuiadmin/style/admin.css">
    <link rel="stylesheet" href="/css/global.css" charset="utf-8">
    <link rel="stylesheet" href="/css/global(1).css" charset="utf-8">
    <link rel="stylesheet" href="/css/store.css" charset="utf-8">
    <link rel="icon" href="image/favicon.ico">
    <style>
        .layui-badge {
            height: 20px;
            line-height: 19px;
            box-sizing: border-box;
        }
        .layui-badge-green {
            color: #52c41a;
            background: #f6ffed;
            border: 1px solid #b7eb8f;
        }
        .layui-badge-blue {
            color: #1890ff;
            background: #e6f7ff;
            border: 1px solid #91d5ff;
        }

        .layui-badge-warm {
            color: #009688;
            background: #e6f7ff;
            border: 1px solid #4cffb3;
        }

        .layui-badge-red{
            color: #961408;
            background: #e6f7ff;
            border: 1px solid #ff4f3b;
        }
    </style>
</head>
<title>我的预约-酒店管理系统</title>
<body>
<!--顶部 start-->
<div class="layui-header header header-store" style="background-color: #083a6d;">
    <div class="layui-container">
        <a class="logo" href="/index/index">
            <img src="/image/logo.png" alt="layui">
        </a>
        <div class="layui-form component" lay-filter="LAY-site-header-component"></div>
        <ul class="layui-nav" id="layui-nav-userinfo">

        </ul>
    </div>
</div>
<!--顶部 end-->
<!--[if lt IE 9]>  <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>  <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script><![endif]-->
<div class="shop-nav shop-index">
    <!--搜索 start-->
    <div id="LAY-topbar" style="height: auto;">
        <form class="layui-form layuimini-form">
            <div class="input-search">
                <div id="searchRoom">
                </div>
                <div class="layui-container layui-hide-xs"> <a href="http://www.xueden.cn/" class="topbar-logo"> <img src="/image/1.jpg"  alt="layui"> </a> </div>
            </div>
        </form>
    </div>
    <!--搜索 end-->
    <div class="shop-banner" style="background: #f2f2f2;">
        <div class="layui-container layui-hide-xs">
            <!--会员菜单 start-->
            <div class="product-list">
                <dl>
                    <dt><a href="/myInfo/myInfo">会员中心</a></dt>
                    <dd><a href="/myInfo/myInfo">个人信息</a></dd>
                    <!--<dd><a href="../hotel/myInfo.html">个人信息</a></dd>-->
                    <!--<dd class="activate"><a href="../hotel/myReserve.html">我的预定</a></dd>-->
                    <dd class="activate"><a href="../hotel/myReserve.html">我的预定</a></dd>
                </dl>
            </div>
            <!--会员菜单 end-->
        </div>

        <div class="layui-container">
            <div class="fly-panel fly-panel-user" pad20="">
                <div class="layui-tab layui-tab-brief" lay-filter="user">
                    <ul class="layui-tab-title" id="LAY_mine">
                        <li class="layui-this" lay-id="info">我的预定</li>
                    </ul>
                    <div class="layui-tab-content" style="padding: 20px 0;    height: 385px;">
                        <table class="layui-hide" id="myReserve" lay-filter="reserveRecordList"></table>
                        <script type="text/html" id="status">
                            {{#  if(d.status == 0){ }}
                            <span class="layui-badge layui-badge-green">已预定，待付款</span>
                            {{#  } else if(d.status == 1) { }}
                            <span class="layui-badge layui-badge-blue">已付款待入住</span>
                            {{#  } else if(d.status == 2) { }}
                            <span class="layui-badge layui-badge-cyan">已入住未退房</span>
                            {{#  } else if(d.status == 3) { }}
                            <span class="layui-badge layui-badge-red">已退订</span>
                            {{#  } else if(d.status == 4) { }}
                            <span class="layui-badge layui-badge-black">已完成</span>
                            {{#  } else { }}
                            <span class="layui-badge layui-badge-warm">已换房</span>
                            {{#  } }}
                        </script>
                        <script type="text/html" id="roomIdTpl">
                            {{#  if(d.room !=null){ }}
                            <span class="layui-badge layui-bg-green">{{d.room.roomNumber}}</span>
                            {{#  } else { }}
                            <span class="layui-badge layui-bg-gray">未知</span>
                            {{#  } }}
                        </script>
                        <script type="text/html" id="standardPriceTpl">

                            {{#  if(d.room !=null){ }}
                            <span class="layui-badge layui-bg-blue">单价：￥{{d.room.standardPrice}}，天数：{{d.reserveDays}}总额：￥{{d.amountMoney}}</span>
                            {{#  } else { }}
                            <span class="layui-badge layui-bg-green">未知</span>
                            {{#  } }}
                        </script>

                        <script type="text/html" id="amountMoneyTpl">
                            {{#  if(d.amountMoney !=null){ }}
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="showStandardPrice"><span class="layui-badge layui-bg-blue">￥{{d.amountMoney}}</span></a>
                            {{#  } else { }}
                            <span class="layui-badge layui-bg-green">未知</span>
                            {{#  } }}
                        </script>
                        <script type="text/html" id="roomNameTpl">
                            {{#  if(d.room !=null){ }}
                            <span>{{d.room.roomName}}</span>
                            {{#  } else { }}
                            <span class="layui-badge layui-bg-green">未知</span>
                            {{#  } }}
                        </script>
                        <script type="text/html" id="currentTableBar">
                            <div class="layui-btn-container">
                                {{#  if(d.status ==1){ }}
                                <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="unsubscribe">退订</a>
                                <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="change">换房</a>
                                {{#  } }}
                                {{#  if(d.status ==0){ }}
                                <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="payment">付款</a>
                                {{#  } }}
                            </div>
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 底部 -->
<div class="fly-footer">
    <p>徐广兴 &nbsp;&nbsp;&nbsp;&nbsp;<i class="layui-icon layui-icon-login-qq"></i> 1832377033  &nbsp;&nbsp;&nbsp;&nbsp;
        <i class="layui-icon layui-icon-cellphone"></i>18317956639
    </p>
</div>
<div id='jsonContainer' class="Canvas" style="display: none"></div>

<script src="/static/layuiadmin/layui/layui.js"></script>
<script src="/static/js/project/index/index.js"></script>
<script>
    layui.config({
        version: "1545301148662"
    }).extend({
        'fly': '../hotel/layui/dist/lay/modules/fly/index'
    }).use(["form","element","fly", "table"], function () {
        let form = layui.form,
            layer = layui.layer,
            element = layui.element,
            table = layui.table,
            $ = layui.$,
            reserveTable;

        //我的预定
        reserveTable = {
            elem: '#myReserve'
            , url: myHotelReserveListUrl
            , method: 'post'
            , cellMinWidth: 80
            , cols: [
                [{type: 'numbers', title: '序号',align:'center'}
                ,{title: '操作', minWidth: 120, templet: '#currentTableBar', align: "center"}
                , {field: 'id', title: 'ID',hide:true,  width: 80, unresize: true, sort: true,align:'center'}
                , {field: 'orderNumber', title: '订单号', minWidth: 260, align:'center'}
                , {field: 'roomId', title: '房间号', width: 80, templet: '#roomIdTpl',align:'center'}
                /*, {field: 'roomName', title: '房间名称', width: 120, templet: '#roomNameTpl',align:'center'}*/
                , {field: 'amountMoney', title: '总金额', width: 100, templet: '#amountMoneyTpl',align:'center'}
                , {field: 'status', title: '订单状态', width: 140,  sort: true, templet: '#status',align:'center'}
                , {
                    field: 'checkinDate',
                    title: '入住时间时间',
                    width: '17%',
                    align:'center',
                    templet: '<span>{{ layui.laytpl.toDateString(d.checkinDate) }}</span>'
                }
                , {
                    field: 'checkoutDate',
                    title: '退房时间',
                    width: '17%',
                    align:'center',
                    templet: '<span>{{ layui.laytpl.toDateString(d.checkoutDate) }}</span>'
                }]
            ]
            , page: true
        };

        table.render(reserveTable);
        //监听表格按钮
        table.on('tool(reserveRecordList)', function (obj) {
            let data = obj.data;
            if (obj.event === 'unsubscribe') {//退订
                layer.confirm("你确定要退订该酒店房间么,将扣除50%费用哦？",{skin:'layui-layer-molv',btn:['是的,我确定','我再想想']},
                    function(){
                        $.post({
                            url: unsubscribeUrl,
                            data: {id: data.id},
                            dataType: "json",
                            timeout:300000,
                            xhrFields:{withCredentials: true},
                            success: function (res) {
                                if(res.success){
                                    layer.msg("退订成功", {time: 1000}, function () {
                                        table.reload('myReserve', table);
                                    });
                                }else{
                                    layer.msg(res.message);
                                }
                            },
                            error: function (res) {
                                layer.msg(res.message);
                            }
                        });
                    }
                )
            }else  if(obj.event === 'change'){//换房
                layui.sessionData('changeRoomData', {
                    key: 'changeRoom'
                    ,value: data
                });

                layer.confirm("你确定要更换该酒店房间么,请交10元换房手续费，退房时少了请补差额，多了就退回给您！",{skin:'layui-layer-molv',btn:['是的,我确定','我再想想']},
                    function(index){
                        layer.close(index);
                        let indexChange = layer.open({
                            title: '我要换房',
                            type: 2,
                            shade: 0.2,
                            anim: 4,
                            shadeClose: true,
                            skin:'layui-layer-molv',
                            area: ['60%', '80%'],
                            content: 'changeRoom.html',
                            success : function(layero, index){
                                setTimeout(function(){

                                },500);
                            }
                        });
                    }
                )
            }else  if(obj.event === 'payment'){//继续付款
                layer.confirm("你确定要继续付款么",{skin:'layui-layer-molv',btn:['是的,我确定','我再想想']},
                    function(index){
                        layer.close(index);

                        $.get({
                            url: getReserveByIdUrl,
                            data:{id:data.id},
                            dataType: "json",
                            timeout:300000,
                            xhrFields:{withCredentials: true},
                            success: function (res) {
                                let contentUlr = "recharge/wechatpay.html";
                                if(res.success){

                                    layui.sessionData('payData', {
                                        key:'pay'
                                        ,value:res.data
                                    });
                                    //设置二维码到期时间
                                    layui.sessionData('timeData', {
                                        key:'time'
                                        ,value:120
                                    });
                                    layer.open({
                                        type: 2
                                        ,id: 'LAY_pushcase'
                                        ,title: '马王天地收银台 收款方：学灯网或骨骨'
                                        ,area: ['700px', '570px']
                                        ,content: contentUlr
                                        ,success: function(layero, index){
                                        }
                                    });
                                    webSocketMsg(res.data.reserve.orderNumber);
                                }else{
                                    layer.msg(res.message);
                                }
                            },
                            error: function () {

                            }
                        });


                    }
                )
            }else  if(obj.event === "showStandardPrice"){//查看价格信息
                let msg = "预定天数："+data.reserveDays+"天,房间单价："+data.room.standardPrice+"元";
                if(data.remarks!=null){
                    msg+= data.remarks;
                }
                layer.alert(msg, {
                    icon: 1,
                    skin:'layui-layer-molv'
                });

            }



        });

        function webSocketMsg(id){

            if ("WebSocket" in window)
            {
                //alert("您的浏览器支持 WebSocket!");

                // 打开一个 web socket
                let ws = new WebSocket(webSocketUrl+""+id+"");
                ws.onopen = function()
                {
                    // Web Socket 已连接上，使用 send() 方法发送数据
                    ws.send("发送数据");
                };

                ws.onmessage = function (evt)
                {
                    let received_msg = JSON.parse(evt.data);

                    /* parent.layer.closeAll();*/
                    /* layer.alert(received_msg.msg, {icon: 1,offset: 'auto',time: 5000,anim: 2}, function (index) {
                         parent.layer.closeAll();
                     });*/

                    layer.alert(received_msg.msg, function(index){
                        parent.layer.closeAll();
                    });

                };

                ws.onclose = function()
                {
                    // 关闭 websocket
                    ws.close();
                    //alert("连接已关闭...");
                    parent.layer.closeAll();
                };

                //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
                window.onbeforeunload = function(){
                    ws.onclose();
                }
            }

            else
            {
                // 浏览器不支持 WebSocket
                //alert("您的浏览器不支持 WebSocket!");
            }

        }


    });

</script>

<ul class="layui-fixbar">
    <li class="layui-icon layui-fixbar-top" lay-type="top" style=""></li>
</ul>
</body>
</html>
